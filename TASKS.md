# MAX Contest Bot — Доска задач

Последнее обновление: 2026-02-11 (реферальная часть запущена)

## Workflow (автоматический режим)

После каждого шага работы:
1. Пишем код
2. `npm run test` (type-check + build + tests)
3. Если тесты проходят → коммит автоматически, без запроса

## 0) Текущее состояние проекта

- [x] Инициализация проекта в репо `MAX`
- [x] Основные сценарии конкурсов: `/newcontest`, `/join`, `/publish`, `/contests`, `/draw`, `/reroll`
- [x] Детерминированная жеребьёвка с proof seed
- [x] Автозавершение истёкших конкурсов
- [x] Проверка подписки на обязательные чаты перед участием
- [x] Автопубликация итогов в чат конкурса (таймер + ручные draw/reroll)
- [~] Реферальная система и бонусные билеты (ядро готово, доработки в процессе)
- [ ] Защита от злоупотреблений и модерация
- [ ] Мини-апп админа / продвинутый UX управления

## 1) Текущий спринт

### В работе

- [~] Реализация реферальных ссылок и бонусных билетов
  - [x] Добавлены поля реферала в модель участника
  - [ ] Обработка `/start <payload>` для реферального входа
  - [x] Правила билетов (базовый + бонус за реферала, лимит)
  - [x] Логика жеребьёвки с учётом веса билетов
  - [x] Обновлена документация по реферальной механике

### Дальше

- [ ] Защита от злоупотреблений
  - [ ] Идемпотентность и защита от дублирования действий
  - [ ] Кулдауны/лимиты для тяжёлых команд
  - [ ] Сигналы о подозрительной активности для админов

- [ ] Улучшение админ-операций
  - [ ] Команда редактирования конкурса (название, дата окончания, число победителей)
  - [ ] Принудительное закрытие/открытие конкурса
  - [ ] Детальный аудит для draw/reroll

## 2) Бэклог (запланировано)

- [ ] Юнит-тесты для draw/repository/обработчиков команд бота
- [ ] Структурированное логирование и сбор ошибок
- [ ] Переход с JSON на SQLite/Postgres
- [ ] Модель ролей (владелец/админ/модератор)
- [ ] Локализация
- [ ] Публичная команда верификации честности (`/proof contest_id`)

## 3) Возможности и ограничения MAX Bot API

Раздел основан на установленном SDK `@maxhub/max-bot-api` в этом репо.

### Что можно делать

- Команды и обработчики:
  - `bot.command(...)`
  - `bot.action(...)` для callback-кнопок
  - `bot.api.setMyCommands(...)`
- Сообщения:
  - `sendMessageToChat(chatId, text, extra?)`
  - `sendMessageToUser(userId, text, extra?)`
  - редактирование/удаление/закрепление сообщений
- Управление чатами:
  - `getChatMembers(chatId, { user_ids })`
  - `getChatAdmins(chatId)`
  - `addChatMembers`, `removeChatMember`, `leaveChat`
- Клавиатуры/кнопки:
  - callback
  - link
  - request_contact
  - request_geo_location
  - chat

### Важные ограничения

- Проверка членства:
  - Для проверки обязательных чатов бот должен иметь доступ к списку участников.
  - Если прав нет или чат недоступен — проверка не пройдёт.
- Нет отдельного API «подписчик канала» в SDK:
  - Проверка через `getChatMembers(...)`.
- ID — числовые:
  - `chat_id` и `user_id` в API — числа.
  - Нечисловые ID нужно отклонять/нормализовать.
- Payload callback — строка:
  - Держать payload коротким и детерминированным.
- Нет встроенного планировщика конкурсов:
  - Автозавершение реализовано в приложении (`setInterval`) и требует стабильного процесса.
- Гибкость области команд в SDK ограничена:
  - Используется глобальная регистрация команд.

## 4) Архитектурные правила

- Жеребьёвка остаётся воспроизводимой и проверяемой.
- Не регистрировать участника без прохождения проверки обязательных чатов.
- Любая админ-операция проверяет admin ID до выполнения.
- Не игнорировать ошибки API, если они влияют на честность.
- Сохранять все важные изменения состояния конкурса в репозитории.

## 5) Definition of Done для следующего этапа

- [ ] Реферальная система работает и задокументирована
- [ ] Взвешенная жеребьёвка работает и покрыта тестами
- [ ] Защита от злоупотреблений на путях join/referral
- [ ] README обновлён с новыми командами и примерами
- [ ] Все проверки проходят (`type-check`, `build`)
